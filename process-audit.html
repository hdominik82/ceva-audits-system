<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audyt Procesów</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .back-btn, .mobile-preview-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .back-btn:hover, .mobile-preview-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .header h1 { color: white; font-size: 1.4em; font-weight: 300; }
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            padding: 0 15px;
            overflow-x: auto;
        }
        .nav-tab {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-tab.active { color: white; border-bottom-color: #45b7d1; }
        .nav-tab:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .content { padding: 15px; height: calc(100vh - 120px); overflow-y: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        #audit.active {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
            padding: 0;
        }
        
        .audit-header {
            background: white;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .audit-body {
            flex: 1;
            overflow-y: auto;
            background: white;
            padding: 20px;
        }
        
        .audit-footer {
            background: white;
            padding: 15px 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        .btn {
            background: #45b7d1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn:hover { background: #3498db; transform: translateY(-2px); }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        .form-inline {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .question-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #45b7d1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .question-number {
            display: inline-block;
            background: #45b7d1;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            margin-right: 10px;
        }
        .question-text { 
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            font-size: 1.05em;
            display: inline;
        }
        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }
        .answer-btn {
            padding: 15px;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: all 0.3s;
            text-align: center;
        }
        .answer-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
        .answer-btn.selected { border-width: 4px; }
        .answer-btn-yes { color: #28a745; border-color: #28a745; }
        .answer-btn-yes.selected { background: #28a745; color: white; }
        .answer-btn-no { color: #dc3545; border-color: #dc3545; }
        .answer-btn-no.selected { background: #dc3545; color: white; }
        .answer-btn-na { color: #6c757d; border-color: #6c757d; }
        .answer-btn-na.selected { background: #6c757d; color: white; }
        .comment-area {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            resize: vertical;
            min-height: 80px;
            margin-top: 10px;
        }
        .cycle-time-input {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #2196f3;
            border-radius: 8px;
            margin-top: 10px;
        }
        .cycle-time-input input {
            width: 120px;
            padding: 10px;
            border: 2px solid #2196f3;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .progress-indicator {
            font-size: 1.1em;
            font-weight: 600;
            color: #45b7d1;
        }
        
        .instruction-header {
            background: linear-gradient(135deg, #45b7d1, #3498db);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .instruction-header h2 {
            font-size: 1.5em;
            margin-bottom: 8px;
        }
        .instruction-header p {
            opacity: 0.95;
            font-size: 0.95em;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #45b7d1;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #45b7d1;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1em;
            color: #666;
            font-weight: 600;
        }
        
        .missing-audits-list {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .missing-audits-list h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        .missing-instruction {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #dc3545;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            background: white;
        }
        .table th, .table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .table tbody tr:hover { background: #f8f9fa; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-positive { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        
        .mobile-preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .mobile-preview-overlay.active {
            display: flex;
        }
        .mobile-frame {
            width: 375px;
            height: 667px;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            position: relative;
            border: 12px solid #333;
        }
        .mobile-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10001;
        }
        
        @media (max-width: 768px) {
            .form-inline {
                grid-template-columns: 1fr;
            }
            .answer-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'">← Powrót</button>
        <h1>Audyt Procesów i Instrukcji</h1>
        <button class="mobile-preview-btn" onclick="toggleMobilePreview()">Podgląd Mobile</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('setup')">Nowy Audyt</button>
        <button class="nav-tab" onclick="showSection('audit')">Przeprowadź</button>
        <button class="nav-tab" onclick="showSection('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showSection('history')">Historia</button>
    </div>

    <div class="content">
        <div id="setup" class="content-section active" style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 25px; color: #333;">Konfiguracja nowego audytu</h2>
            
            <div class="form-inline">
                <div class="form-group">
                    <label>Data audytu:</label>
                    <input type="date" id="auditDate" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Audytor:</label>
                    <input type="text" id="auditor" class="form-control" placeholder="Imię i nazwisko">
                </div>
                
                <div class="form-group">
                    <label>Zakres audytu:</label>
                    <select id="auditScope" class="form-control" onchange="loadScopeOptions()">
                        <option value="">-- Wybierz zakres --</option>
                        <option value="department">Cały dział</option>
                        <option value="process">Proces w dziale</option>
                        <option value="instruction">Pojedyncza instrukcja</option>
                    </select>
                </div>
            </div>
            
            <div id="scopeOptions"></div>
            <div id="scopePreview" style="margin-top: 20px;"></div>
            
            <button class="btn btn-success" onclick="startAudit()" id="startAuditBtn" style="display: none; margin-top: 20px; font-size: 1.1em; padding: 15px 30px;">
                Rozpocznij audyt
            </button>
        </div>

        <div id="audit" class="content-section">
            <div class="audit-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 id="auditTitle" style="color: #333; margin-bottom: 5px;">Audyt instrukcji</h3>
                        <p id="auditSubtitle" style="color: #666; font-size: 0.9em;">-</p>
                    </div>
                    <div class="progress-indicator" id="progressIndicator">0 / 0</div>
                </div>
            </div>
            
            <div class="audit-body" id="questionsContainer"></div>
            
            <div class="audit-footer">
                <button class="btn btn-secondary" onclick="showSection('setup')">← Wstecz</button>
                <button class="btn btn-success" onclick="submitAudit()">Zakończ i zapisz audyt</button>
            </div>
        </div>

        <div id="dashboard" class="content-section" style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 25px; color: #333;">Dashboard kontroli instrukcji</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalInstructions">0</div>
                    <div class="stat-label">Wszystkie instrukcje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="auditedThisYear">0</div>
                    <div class="stat-label">Sprawdzone w tym roku</div>
                </div>
                <div class="stat-card" style="border-left-color: #dc3545;">
                    <div class="stat-number" id="missingAudits" style="color: #dc3545;">0</div>
                    <div class="stat-label">Brak audytu w tym roku</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="complianceRate">0%</div>
                    <div class="stat-label">Współczynnik zgodności</div>
                </div>
            </div>
            
            <div id="missingAuditsList"></div>
            
            <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">Trend wyników auditów</h3>
                <canvas id="auditChart" height="80"></canvas>
            </div>
        </div>

        <div id="history" class="content-section" style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 25px; color: #333;">Historia Auditów</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Audytor</th>
                        <th>Zakres</th>
                        <th>Wynik</th>
                        <th>Status</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="historyTable"></tbody>
            </table>
        </div>
    </div>

    <div class="mobile-preview-overlay" id="mobilePreview">
        <button class="close-preview" onclick="toggleMobilePreview()">×</button>
        <div class="mobile-frame">
            <div class="mobile-content" id="mobileContent">
                <div style="padding: 15px; text-align: center; color: #666; margin-top: 50px;">
                    Rozpocznij audyt aby zobaczyć podgląd mobilny
                </div>
            </div>
        </div>
    </div>

    <script>
        let instructions = JSON.parse(localStorage.getItem('instructions') || '[]');
        let deptStructure = JSON.parse(localStorage.getItem('dept_structure') || '[]');
        let auditHistory = JSON.parse(localStorage.getItem('process_audit_history') || '[]');
        let actionPlan = JSON.parse(localStorage.getItem('action_plan') || '[]');
        let currentAuditData = null;
        let auditChart = null;

        const auditQuestions = [
            { id: 1, text: "Czy instrukcja jest dostępna na stanowisku pracy?", requiresComment: false },
            { id: 2, text: "Czy instrukcja zawiera aktualny numer wersji?", requiresComment: false },
            { id: 3, text: "Czy instrukcja jest czytelna i nieuszkodzona?", requiresComment: false },
            { id: 4, text: "Czy pracownik zna i stosuje się do instrukcji?", requiresComment: false },
            { id: 5, text: "Czy instrukcja zawiera wymagane elementy (zdjęcia, schematy)?", requiresComment: false },
            { id: 6, text: "Czy faktyczny czas cyklu odpowiada czasowi z instrukcji?", requiresComment: false, requiresCycleTime: true }
        ];

        document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];

        function showSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.target.classList.add('active');
            
            if (name === 'dashboard') loadDashboard();
            else if (name === 'history') loadHistory();
        }

        function loadScopeOptions() {
            const scope = document.getElementById('auditScope').value;
            const container = document.getElementById('scopeOptions');
            const preview = document.getElementById('scopePreview');
            const startBtn = document.getElementById('startAuditBtn');
            
            if (!scope) {
                container.innerHTML = '';
                preview.innerHTML = '';
                startBtn.style.display = 'none';
                return;
            }
            
            let html = '';
            
            if (scope === 'department') {
                html = `<div class="form-group" style="margin-top: 20px;">
                    <label>Wybierz dział:</label>
                    <select id="selectedDept" class="form-control" onchange="previewAuditScope()">
                        <option value="">-- Wybierz dział --</option>
                        ${deptStructure.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                    </select>
                </div>`;
            } else if (scope === 'process') {
                html = `<div class="form-inline" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Wybierz dział:</label>
                        <select id="selectedDept" class="form-control" onchange="loadProcessesForDept()">
                            <option value="">-- Wybierz dział --</option>
                            ${deptStructure.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Wybierz proces:</label>
                        <select id="selectedProcess" class="form-control" onchange="previewAuditScope()">
                            <option value="">-- Najpierw wybierz dział --</option>
                        </select>
                    </div>
                </div>`;
            } else if (scope === 'instruction') {
                html = `<div class="form-group" style="margin-top: 20px;">
                    <label>Wybierz instrukcję:</label>
                    <select id="selectedInstruction" class="form-control" onchange="previewAuditScope()">
                        <option value="">-- Wybierz instrukcję --</option>
                        ${instructions.map(i => `<option value="${i.id}">${i.number} - ${i.name}</option>`).join('')}
                    </select>
                </div>`;
            }
            
            container.innerHTML = html;
            preview.innerHTML = '';
            startBtn.style.display = 'none';
        }

        function loadProcessesForDept() {
            const deptId = parseInt(document.getElementById('selectedDept').value);
            const processSelect = document.getElementById('selectedProcess');
            
            if (!deptId) {
                processSelect.innerHTML = '<option value="">-- Najpierw wybierz dział --</option>';
                return;
            }
            
            const dept = deptStructure.find(d => d.id === deptId);
            if (dept && dept.processes) {
                processSelect.innerHTML = '<option value="">-- Wybierz proces --</option>' +
                    dept.processes.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
        }

        function previewAuditScope() {
            const scope = document.getElementById('auditScope').value;
            const preview = document.getElementById('scopePreview');
            const startBtn = document.getElementById('startAuditBtn');
            let instructionsList = [];
            
            if (scope === 'department') {
                const deptId = parseInt(document.getElementById('selectedDept').value);
                if (!deptId) return;
                
                const dept = deptStructure.find(d => d.id === deptId);
                instructionsList = instructions.filter(i => i.department === dept.name);
                
                preview.innerHTML = `<div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 5px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">Zakres audytu: Cały dział ${dept.name}</h3>
                    <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 15px;">
                        Liczba instrukcji do sprawdzenia: <span style="color: #2196f3;">${instructionsList.length}</span>
                    </p>
                    <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                        ${instructionsList.map(i => `<div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #45b7d1;">
                            <strong>${i.number}</strong> - ${i.name}<br>
                            <small style="color: #666;">Typ: ${i.type} | Czas cyklu: ${i.cycleTime}s | ${i.unit}</small>
                        </div>`).join('')}
                    </div>
                </div>`;
            } else if (scope === 'process') {
                const deptId = parseInt(document.getElementById('selectedDept').value);
                const processId = parseInt(document.getElementById('selectedProcess').value);
                if (!deptId || !processId) return;
                
                const dept = deptStructure.find(d => d.id === deptId);
                const process = dept.processes.find(p => p.id === processId);
                instructionsList = instructions.filter(i => 
                    i.department === dept.name && i.processes && i.processes.includes(process.name)
                );
                
                preview.innerHTML = `<div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">Zakres audytu: Proces ${process.name} (${dept.name})</h3>
                    <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 15px;">
                        Liczba instrukcji do sprawdzenia: <span style="color: #4caf50;">${instructionsList.length}</span>
                    </p>
                    <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                        ${instructionsList.map(i => `<div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #66bb6a;">
                            <strong>${i.number}</strong> - ${i.name}<br>
                            <small style="color: #666;">Typ: ${i.type} | Czas cyklu: ${i.cycleTime}s | ${i.unit}</small>
                        </div>`).join('')}
                    </div>
                </div>`;
            } else if (scope === 'instruction') {
                const instId = parseInt(document.getElementById('selectedInstruction').value);
                if (!instId) return;
                
                const inst = instructions.find(i => i.id === instId);
                instructionsList = [inst];
                
                preview.innerHTML = `<div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 5px solid #ff9800;">
                    <h3 style="color: #e65100; margin-bottom: 15px;">Zakres audytu: Pojedyncza instrukcja</h3>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #ffb74d;">
                        <strong style="font-size: 1.1em;">${inst.number}</strong> - ${inst.name}<br>
                        <small style="color: #666;">Typ: ${inst.type} | Czas cyklu: ${inst.cycleTime}s | ${inst.unit} | Dział: ${inst.department}</small>
                    </div>
                </div>`;
            }
            
            if (instructionsList.length > 0) {
                startBtn.style.display = 'block';
                currentAuditData = { instructions: instructionsList };
            } else {
                startBtn.style.display = 'none';
            }
        }

        function startAudit() {
            const date = document.getElementById('auditDate').value;
            const auditor = document.getElementById('auditor').value.trim();
            
            if (!date || !auditor || !currentAuditData) {
                alert('Proszę wypełnić wszystkie wymagane pola');
                return;
            }
            
            currentAuditData.date = date;
            currentAuditData.auditor = auditor;
            currentAuditData.scope = document.getElementById('auditScope').value;
            currentAuditData.scopeLabel = getScopeLabel();
            
            renderAuditQuestions();
            showSection('audit');
            updateMobilePreview();
        }

        function renderAuditQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            document.getElementById('auditTitle').textContent = `Audyt: ${currentAuditData.scopeLabel}`;
            document.getElementById('auditSubtitle').textContent = `Audytor: ${currentAuditData.auditor} | Data: ${currentAuditData.date}`;
            
            let totalQuestions = currentAuditData.instructions.length * auditQuestions.length;
            document.getElementById('progressIndicator').textContent = `0 / ${totalQuestions}`;
            
            currentAuditData.instructions.forEach((inst, instIdx) => {
                const instSection = document.createElement('div');
                instSection.innerHTML = `
                    <div class="instruction-header">
                        <h2>${inst.number} - ${inst.name}</h2>
                        <p>Typ: ${inst.type} | Czas cyklu standardowy: ${inst.cycleTime}s | Jednostka: ${inst.unit}</p>
                    </div>
                `;
                
                auditQuestions.forEach((q, qIdx) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-item';
                    questionDiv.innerHTML = `
                        <div>
                            <span class="question-number">${qIdx + 1}</span>
                            <span class="question-text">${q.text}</span>
                        </div>
                        <div class="answer-buttons">
                            <button class="answer-btn answer-btn-yes" 
                                    onclick="selectAnswer(${instIdx}, ${qIdx}, 'yes', this)">Tak</button>
                            <button class="answer-btn answer-btn-no" 
                                    onclick="selectAnswer(${instIdx}, ${qIdx}, 'no', this)">Nie</button>
                            <button class="answer-btn answer-btn-na" 
                                    onclick="selectAnswer(${instIdx}, ${qIdx}, 'na', this)">N/A</button>
                        </div>
                        ${q.requiresCycleTime ? `
                            <div class="cycle-time-input" id="cycleTime_${instIdx}_${qIdx}" style="display: none;">
                                <span style="font-weight: 600;">Czas standardowy: <span style="color: #2196f3;">${inst.cycleTime}s</span></span>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    Zmierzony czas:
                                    <input type="number" id="measuredTime_${instIdx}_${qIdx}" 
                                           placeholder="sekundy" step="0.1" min="0">
                                </label>
                            </div>
                        ` : ''}
                        <textarea class="comment-area" id="comment_${instIdx}_${qIdx}" 
                                  placeholder="Opcjonalny komentarz... (wymagany dla odpowiedzi 'Nie')" 
                                  style="display: none;"></textarea>
                        <input type="hidden" id="answer_${instIdx}_${qIdx}">
                    `;
                    instSection.appendChild(questionDiv);
                });
                
                container.appendChild(instSection);
            });
        }

        function selectAnswer(instIdx, qIdx, value, btn) {
            const item = btn.closest('.question-item');
            item.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            document.getElementById(`answer_${instIdx}_${qIdx}`).value = value;
            
            const comment = document.getElementById(`comment_${instIdx}_${qIdx}`);
            const cycleTime = document.getElementById(`cycleTime_${instIdx}_${qIdx}`);
            
            if (value === 'no') {
                comment.style.display = 'block';
            } else {
                comment.style.display = 'none';
                comment.value = '';
            }
            
            if (cycleTime && value === 'yes') {
                cycleTime.style.display = 'flex';
            } else if (cycleTime) {
                cycleTime.style.display = 'none';
            }
            
            updateProgress();
            updateMobilePreview();
        }

        function updateProgress() {
            let answered = 0;
            let total = currentAuditData.instructions.length * auditQuestions.length;
            
            currentAuditData.instructions.forEach((inst, instIdx) => {
                auditQuestions.forEach((q, qIdx) => {
                    const answer = document.getElementById(`answer_${instIdx}_${qIdx}`).value;
                    if (answer) answered++;
                });
            });
            
            document.getElementById('progressIndicator').textContent = `${answered} / ${total}`;
        }

        function submitAudit() {
            const results = [];
            let totalQuestions = 0;
            let correctAnswers = 0;
            let nonCompliantItems = [];
            
            currentAuditData.instructions.forEach((inst, instIdx) => {
                const instResult = {
                    instruction: inst,
                    answers: []
                };
                
                auditQuestions.forEach((q, qIdx) => {
                    const answer = document.getElementById(`answer_${instIdx}_${qIdx}`).value;
                    const comment = document.getElementById(`comment_${instIdx}_${qIdx}`).value.trim();
                    
                    if (!answer) return;
                    
                    totalQuestions++;
                    if (answer === 'yes' || answer === 'na') correctAnswers++;
                    
                    const answerData = {
                        question: q.text,
                        answer: answer,
                        comment: comment
                    };
                    
                    if (q.requiresCycleTime && answer === 'yes') {
                        const measured = document.getElementById(`measuredTime_${instIdx}_${qIdx}`).value;
                        if (measured) {
                            answerData.standardTime = inst.cycleTime;
                            answerData.measuredTime = parseFloat(measured);
                            answerData.deviation = Math.abs(inst.cycleTime - parseFloat(measured));
                            
                            const deviationPercent = (answerData.deviation / inst.cycleTime) * 100;
                            if (deviationPercent > 10) {
                                nonCompliantItems.push({
                                    instruction: inst,
                                    issue: `Czas cyklu odchyla się o ${deviationPercent.toFixed(1)}%`,
                                    details: `Standardowy: ${inst.cycleTime}s, Zmierzony: ${measured}s`
                                });
                            }
                        }
                    }
                    
                    if (answer === 'no') {
                        nonCompliantItems.push({
                            instruction: inst,
                            issue: q.text,
                            details: comment || 'Brak szczegółów'
                        });
                    }
                    
                    instResult.answers.push(answerData);
                });
                
                results.push(instResult);
            });
            
            const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            
            const audit = {
                id: Date.now(),
                date: currentAuditData.date,
                auditor: currentAuditData.auditor,
                scope: currentAuditData.scope,
                scopeLabel: currentAuditData.scopeLabel,
                results: results,
                score: score,
                status: score >= 80 ? 'Pozytywny' : 'Wymaga uwagi',
                instructionIds: currentAuditData.instructions.map(i => i.id)
            };
            
            auditHistory.push(audit);
            localStorage.setItem('process_audit_history', JSON.stringify(auditHistory));
            
            if (nonCompliantItems.length > 0) {
                nonCompliantItems.forEach(item => {
                    const action = {
                        id: Date.now() + Math.random(),
                        source: 'Audyt Procesów',
                        description: `${item.instruction.number} - ${item.instruction.name}: ${item.issue}`,
                        actions: `Wymagana aktualizacja instrukcji: ${item.details}`,
                        status: 'Otwarte',
                        responsible: currentAuditData.auditor,
                        priority: 'high',
                        createdDate: currentAuditData.date,
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        instructionId: item.instruction.id,
                        requiresInstructionUpdate: true
                    };
                    actionPlan.push(action);
                });
                localStorage.setItem('action_plan', JSON.stringify(actionPlan));
            }
            
            alert(`Audyt zapisany! Wynik: ${score}%\n${nonCompliantItems.length > 0 ? `\nDodano ${nonCompliantItems.length} akcji do Action Plan` : ''}`);
            
            showSection('dashboard');
        }

        function getScopeLabel() {
            const scope = document.getElementById('auditScope').value;
            
            if (scope === 'department') {
                const deptId = parseInt(document.getElementById('selectedDept').value);
                const dept = deptStructure.find(d => d.id === deptId);
                return `Dział: ${dept.name}`;
            } else if (scope === 'process') {
                const deptId = parseInt(document.getElementById('selectedDept').value);
                const processId = parseInt(document.getElementById('selectedProcess').value);
                const dept = deptStructure.find(d => d.id === deptId);
                const process = dept.processes.find(p => p.id === processId);
                return `Proces: ${process.name} (${dept.name})`;
            } else if (scope === 'instruction') {
                const instId = parseInt(document.getElementById('selectedInstruction').value);
                const inst = instructions.find(i => i.id === instId);
                return `Instrukcja: ${inst.number} - ${inst.name}`;
            }
            
            return '';
        }

        function loadDashboard() {
            const currentYear = new Date().getFullYear();
            const auditedInstructionIds = new Set();
            
            auditHistory.forEach(audit => {
                const auditYear = new Date(audit.date).getFullYear();
                if (auditYear === currentYear && audit.instructionIds) {
                    audit.instructionIds.forEach(id => auditedInstructionIds.add(id));
                }
            });
            
            const totalInstructions = instructions.length;
            const auditedThisYear = auditedInstructionIds.size;
            const missingAudits = totalInstructions - auditedThisYear;
            const complianceRate = totalInstructions > 0 ? Math.round((auditedThisYear / totalInstructions) * 100) : 0;
            
            document.getElementById('totalInstructions').textContent = totalInstructions;
            document.getElementById('auditedThisYear').textContent = auditedThisYear;
            document.getElementById('missingAudits').textContent = missingAudits;
            document.getElementById('complianceRate').textContent = complianceRate + '%';
            
            const missingList = document.getElementById('missingAuditsList');
            if (missingAudits > 0) {
                const missingInstructions = instructions.filter(i => !auditedInstructionIds.has(i.id));
                
                missingList.innerHTML = `
                    <div class="missing-audits-list">
                        <h3>Instrukcje bez audytu w ${currentYear} roku (${missingAudits})</h3>
                        ${missingInstructions.map(inst => `
                            <div class="missing-instruction">
                                <strong>${inst.number}</strong> - ${inst.name}<br>
                                <small>Dział: ${inst.department} | Typ: ${inst.type}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                missingList.innerHTML = `
                    <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #155724;">Wszystkie instrukcje zostały sprawdzone w tym roku!</h3>
                    </div>
                `;
            }
            
            const ctx = document.getElementById('auditChart');
            if (auditChart) auditChart.destroy();
            
            const last6Audits = auditHistory.slice(-6);
            
            auditChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last6Audits.map(a => a.date),
                    datasets: [{
                        label: 'Wynik audytu (%)',
                        data: last6Audits.map(a => a.score),
                        borderColor: '#45b7d1',
                        backgroundColor: 'rgba(69, 183, 209, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        function loadHistory() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            [...auditHistory].reverse().forEach(audit => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${audit.date}</td>
                    <td>${audit.auditor}</td>
                    <td>${audit.scopeLabel}</td>
                    <td><strong>${audit.score}%</strong></td>
                    <td><span class="status-badge ${audit.status === 'Pozytywny' ? 'status-positive' : 'status-warning'}">${audit.status}</span></td>
                    <td>
                        <button class="btn" onclick="viewDetails(${audit.id})" style="padding: 5px 12px; font-size: 0.85em;">Szczegóły</button>
                    </td>
                `;
            });
        }

        function viewDetails(id) {
            const audit = auditHistory.find(a => a.id === id);
            if (!audit) return;
            
            let details = `AUDYT PROCESÓW\n${'='.repeat(50)}\n\n`;
            details += `Data: ${audit.date}\n`;
            details += `Audytor: ${audit.auditor}\n`;
            details += `Zakres: ${audit.scopeLabel}\n`;
            details += `Wynik: ${audit.score}%\n`;
            details += `Status: ${audit.status}\n\n`;
            
            audit.results.forEach(r => {
                details += `${'─'.repeat(50)}\n`;
                details += `${r.instruction.number} - ${r.instruction.name}\n`;
                details += `${'─'.repeat(50)}\n\n`;
                r.answers.forEach((a, idx) => {
                    details += `${idx + 1}. ${a.question}\n`;
                    details += `   Odpowiedź: ${a.answer.toUpperCase()}\n`;
                    if (a.comment) details += `   Komentarz: ${a.comment}\n`;
                    if (a.measuredTime) {
                        details += `   Czas standardowy: ${a.standardTime}s\n`;
                        details += `   Czas zmierzony: ${a.measuredTime}s\n`;
                        details += `   Odchylenie: ${a.deviation}s (${((a.deviation/a.standardTime)*100).toFixed(1)}%)\n`;
                    }
                    details += '\n';
                });
            });
            
            alert(details);
        }

        function toggleMobilePreview() {
            const overlay = document.getElementById('mobilePreview');
            overlay.classList.toggle('active');
        }

        function updateMobilePreview() {
            const mobileContent = document.getElementById('mobileContent');
            const auditBody = document.getElementById('questionsContainer');
            
            if (auditBody && auditBody.innerHTML) {
                mobileContent.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 5px;">${currentAuditData ? currentAuditData.scopeLabel : 'Audyt'}</h3>
                        <p style="font-size: 0.85em; opacity: 0.9;">${document.getElementById('progressIndicator').textContent}</p>
                    </div>
                    <div style="padding: 15px;">
                        ${auditBody.innerHTML}
                    </div>
                `;
            }
        }

        if (deptStructure.length === 0) {
            deptStructure = [
                {
                    id: 1,
                    name: 'B2B',
                    processes: [
                        { id: 101, name: 'Montaż B2B', target: 3 },
                        { id: 102, name: 'Pakowanie B2B', target: 2 }
                    ]
                }
            ];
            localStorage.setItem('dept_structure', JSON.stringify(deptStructure));
        }
    </script>
</body>
</html>