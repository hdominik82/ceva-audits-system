<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audyt 5S - CEVA Mobile</title>
    <script src="mobile-config-loader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5986 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .back-btn:active { transform: scale(0.95); }
        .header-title {
            color: white;
            font-size: 1.3em;
            font-weight: 300;
        }
        .content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .progress {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 20px;
        }
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }
        .category-header {
            background: #4ecdc4;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }
        .question-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4ecdc4;
        }
        .question-number {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            line-height: 1.4;
            font-size: 0.95em;
        }
        .answer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .answer-btn {
            padding: 15px 10px;
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.95em;
        }
        .answer-btn:active { transform: scale(0.95); }
        .answer-btn.selected { border-width: 4px; }
        .answer-btn-yes { color: #28a745; border-color: #28a745; }
        .answer-btn-yes.selected { background: #28a745; color: white; }
        .answer-btn-no { color: #dc3545; border-color: #dc3545; }
        .answer-btn-no.selected { background: #dc3545; color: white; }
        .answer-btn-na { color: #6c757d; border-color: #6c757d; }
        .answer-btn-na.selected { background: #6c757d; color: white; }
        .comment-area {
            width: 100%;
            padding: 12px;
            border: 2px solid #dc3545;
            border-radius: 8px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 80px;
            margin-top: 10px;
            display: none;
            background: #fff5f5;
        }
        .comment-area.visible { display: block; }
        .comment-label {
            color: #dc3545;
            font-weight: 600;
            font-size: 0.85em;
            margin-top: 10px;
            display: none;
        }
        .comment-label.visible { display: block; }
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .submit-btn:active { transform: scale(0.98); }
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            display: none;
        }
        .result-card.visible { display: block; }
        .score-display {
            font-size: 4em;
            font-weight: bold;
            color: #4ecdc4;
            margin: 20px 0;
        }
        .score-status {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .score-status.pass { color: #28a745; }
        .score-status.fail { color: #dc3545; }
        .sharepoint-section {
            background: #f0f8ff;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .sharepoint-section h3 {
            color: #4ecdc4;
            margin-bottom: 15px;
        }
        .sharepoint-section ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        .file-name {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85em;
            word-break: break-all;
        }
        .btn-sharepoint {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        .btn-new {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .required-star { color: #dc3545; }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='mobile-index.html'">‚Üê Powr√≥t</button>
        <div class="header-title">Audyt 5S</div>
        <div style="width:80px"></div>
    </div>

    <div class="content">
        <div class="progress" id="progress">Postƒôp: 0 / 27 pyta≈Ñ</div>

        <div id="formSection">
            <div class="form-card">
                <div class="form-group">
                    <label>Data audytu:</label>
                    <input type="date" id="auditDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>Strefa:</label>
                    <select id="zone" class="form-control">
                        <option value="">-- Wybierz strefƒô --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Audytor:</label>
                    <select id="auditor" class="form-control">
                        <option value="">-- Wybierz audytora --</option>
                    </select>
                </div>
            </div>

            <div id="questionsContainer"></div>

            <button class="submit-btn" onclick="saveAudit()">Zapisz audyt i pobierz JSON</button>
        </div>

        <div id="resultSection" class="result-card">
            <div class="score-display" id="scoreDisplay">0%</div>
            <div class="score-status" id="scoreStatus">Status</div>
            
            <div class="sharepoint-section">
                <h3>üì§ Prze≈õlij na SharePoint</h3>
                <ol>
                    <li>Kliknij przycisk "Otw√≥rz SharePoint" poni≈ºej</li>
                    <li>W folderze kliknij <strong>+ Nowy ‚Üí Przeka≈º pliki</strong></li>
                    <li>Wybierz pobrany plik JSON:</li>
                </ol>
                <div class="file-name" id="fileName">audit_5s.json</div>
                <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                    Po przes≈Çaniu pliku, dane bƒôdƒÖ dostƒôpne w wersji desktop do analizy.
                </p>
            </div>

            <button class="btn-sharepoint" id="openSharePoint">
                üìÅ Otw√≥rz SharePoint - folder 5S
            </button>
            
            <button class="btn-new" onclick="location.reload()">
                üîÑ Nowy audyt
            </button>
        </div>
    </div>

    <script>
        if (typeof CEVA_CONFIG === 'undefined' || !CEVA_CONFIG.getCurrentBranch) {
    document.addEventListener('DOMContentLoaded', async function() {
        CEVA_CONFIG = await CONFIG_LOADER.load();
        initializePage();
    });
} else {
    document.addEventListener('DOMContentLoaded', initializePage);
}

function initializePage() {
    const branch = CEVA_CONFIG.getCurrentBranch();
     
        
        // WSZYSTKIE 27 PYTA≈É - zgodne z wersjƒÖ desktop
        const questions = [
            // 1S - Sortowanie (5 pyta≈Ñ)
            {category: 1, question: "Tylko przedmioty potrzebne do realizacji procesu (zgodnie z instrukcjƒÖ pracy oraz okre≈õlonym standardem)"},
            {category: 1, question: "Nie ma pozostawionych przedmiot√≥w w alejkach, ≈õcie≈ºce dla pieszych, korytarzach, schodach, kƒÖtach"},
            {category: 1, question: "Wszystkie artyku≈Çy zu≈ºywalne (karton, biurowe, etykiety, ta≈õmy, etc.) posiadajƒÖ okre≈õlone poziomy min i max w miejscach pobra≈Ñ"},
            {category: 1, question: "Brak przeszk√≥d stanowiƒÖcych potencjalne zagro≈ºenie (otwarte szuflady, kable, palety, etc.)"},
            {category: 1, question: "Ga≈õnica i hydrant niezastawione"},
            
            // 2S - Systematyczno≈õƒá (6 pyta≈Ñ)
            {category: 2, question: "Przedmioty znajdujƒÖ siƒô w opisanych/oznaczonych miejscach lub zgodnie z okre≈õlonym zdjƒôciem/schematem rozmieszczenia (na biurku, stacji roboczej, obszarze)"},
            {category: 2, question: "Szafki, stacje robocze, dzia≈Çy i obszary sƒÖ oznaczone (znaki, oznaczenia poziome, kraty, etc.)"},
            {category: 2, question: "Uszkodzone materia≈Çy i wyposa≈ºenie sƒÖ w≈Ça≈õciwie odseparowane i oznakowane (palety, produkty, drukarki, narzƒôdzia, ≈õrodki transportu, etc.)"},
            {category: 2, question: "IstniejƒÖ shadow boards (zgodne ze standardem CEVA) i sƒÖ one u≈ºywane zgodnie z zasadami (przedmioty odk≈Çadane w odpowiednie miejsce). W biurze, ≈õrodki czysto≈õci trzymane sƒÖ w zdefiniowanych miejscach."},
            {category: 2, question: "Materia≈Çy (palety, dokumenty, etc.) sƒÖ sk≈Çadowane zgodnie z okre≈õlonym standardem"},
            {category: 2, question: "Przedmioty sƒÖ odk≈Çadane na swoje miejsce po u≈ºyciu (zszywacz, skaner, dokumenty, ≈õr. transportu, narzƒôdzia)"},
            
            // 3S - SprzƒÖtanie (4 pytania)
            {category: 3, question: "Stacje robocze (pod≈Çoga, sto≈Çy, biurka), maszyny (≈õr. transportu, owijarka, etc.) oraz wyposa≈ºenie (telefony, komputery, drukarki, etc.) sƒÖ czyste"},
            {category: 3, question: "Obszar jest zabezpieczony przed niebezpiecze≈Ñstwami wynikajƒÖcymi z wyciek√≥w (wody, benzyny, chemikali√≥w, etc.)"},
            {category: 3, question: "Odpady sƒÖ w≈Ça≈õciwie posegregowane (papier, plastik, etc.)"},
            {category: 3, question: "Nie ma odpad√≥w na pod≈Çodze (plastik, papier, karton, puszki, kubki po napojach) a w obszarze utrzymywana jest czysto≈õƒá"},
            
            // 4S - Standaryzacja (5 pyta≈Ñ)
            {category: 4, question: "Ka≈ºda zapytana osoba potrafi wyja≈õniƒá swƒÖ odpowiedzialno≈õƒá za 5S w danym obszarze oraz na terenie zak≈Çadu"},
            {category: 4, question: "Istnieje okre≈õlony standard dla ka≈ºdego obszaru roboczego, stacji roboczej, biurka, etc. (zdjƒôcie, schemat, oznaczenia wizualne)"},
            {category: 4, question: "Zdefiniowano czynno≈õci dot. sprzƒÖtania, zar√≥wno og√≥lnie dla dzia≈Çu jak i dla konkretnego wyposa≈ºenia (listy kontrolne); listy kontrolne sƒÖ podpisywane z okre≈õlonƒÖ czƒôstotliwo≈õciƒÖ"},
            {category: 4, question: "Istnieje lista dzia≈Ça≈Ñ korygujƒÖcych oparta na wynikach audytu 5S"},
            {category: 4, question: "Obszar istnieje na mapie 5S, znajduje siƒô na harmonogramie audyt√≥w 5S oraz jest brany pod uwagƒô przy wyliczaniu wyniku magazynu"},
            
            // 5S - Samodyscyplina (7 pyta≈Ñ)
            {category: 5, question: "Wszyscy pracownicy zostali formalnie przeszkoleni z 5S (udokumentowane)"},
            {category: 5, question: "Audyt 5S przeprowadzany jest przynajmniej raz w miesiƒÖcu"},
            {category: 5, question: "Wyniki obszaru oraz dzia≈Çania korygujƒÖce sƒÖ omawiane z wszystkimi pracownikami podczas spotka≈Ñ przedzmianowych"},
            {category: 5, question: "Wyniki obszaru, targety i dzia≈Çania korygujƒÖce sƒÖ aktualizowane na tablicy 5S"},
            {category: 5, question: "Dzia≈Çania korygujƒÖce z poprzednich audyt√≥w sƒÖ zrealizowane lub w trakcie realizacji"},
            {category: 5, question: "Wyniki ostatniego audytu 5S zosta≈Çy om√≥wione przez odpowiedzialnego za obszar (1) i kierownika obszaru (2)"},
            {category: 5, question: "Je≈ºeli zaobserwowano odstƒôpstwa od standardu podczas audytu, nastƒôpuje natychmiastowa reakcja ze strony innego pracownika lub nadzorcy"}
        ];
        
        const categoryNames = ['Sortowanie', 'Systematyczno≈õƒá', 'SprzƒÖtanie', 'Standaryzacja', 'Samodyscyplina'];
        let answers = {};
        let comments = {};

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];
            
            const zoneSelect = document.getElementById('zone');
            branch.zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.name;
                option.textContent = `${zone.name} (Cel: ${zone.target}%)`;
                option.dataset.target = zone.target;
                option.dataset.responsible = zone.responsible;
                zoneSelect.appendChild(option);
            });
            
            const auditorSelect = document.getElementById('auditor');
            branch.auditors.forEach(auditor => {
                const option = document.createElement('option');
                option.value = auditor;
                option.textContent = auditor;
                auditorSelect.appendChild(option);
            });
            
            renderQuestions();
        });

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            let questionNumber = 1;
            
            for (let cat = 1; cat <= 5; cat++) {
                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = `${cat}S - ${categoryNames[cat - 1]}`;
                container.appendChild(header);
                
                questions.filter(q => q.category === cat).forEach((q, idx) => {
                    const key = `${cat}_${idx}`;
                    
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-item';
                    questionDiv.innerHTML = `
                        <div class="question-number">Pytanie ${questionNumber}</div>
                        <div class="question-text">${q.question}</div>
                        <div class="answer-buttons">
                            <button class="answer-btn answer-btn-yes" onclick="selectAnswer('${key}', 'yes', this)">
                                ‚úì Tak
                            </button>
                            <button class="answer-btn answer-btn-no" onclick="selectAnswer('${key}', 'no', this)">
                                ‚úó Nie
                            </button>
                            <button class="answer-btn answer-btn-na" onclick="selectAnswer('${key}', 'na', this)">
                                ‚àí N/A
                            </button>
                        </div>
                        <div class="comment-label" id="label_${key}">
                            <span class="required-star">*</span> Wymagany komentarz - opisz problem:
                        </div>
                        <textarea 
                            class="comment-area" 
                            id="comment_${key}" 
                            placeholder="Opisz szczeg√≥≈Çowo problem i jego wp≈Çyw na proces..."
                        ></textarea>
                    `;
                    container.appendChild(questionDiv);
                    questionNumber++;
                });
            }
        }

        function selectAnswer(key, value, btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            answers[key] = value;
            
            const commentArea = document.getElementById(`comment_${key}`);
            const commentLabel = document.getElementById(`label_${key}`);
            
            if (value === 'no') {
                commentArea.classList.add('visible');
                commentLabel.classList.add('visible');
                commentArea.required = true;
            } else {
                commentArea.classList.remove('visible');
                commentLabel.classList.remove('visible');
                commentArea.required = false;
                commentArea.value = '';
                delete comments[key];
            }
            
            updateProgress();
        }

        function updateProgress() {
            const total = questions.length;
            const answered = Object.keys(answers).length;
            document.getElementById('progress').textContent = `Postƒôp: ${answered} / ${total} pyta≈Ñ`;
        }

        function saveAudit() {
            const date = document.getElementById('auditDate').value;
            const zone = document.getElementById('zone').value;
            const auditor = document.getElementById('auditor').value;

            if (!date || !zone || !auditor) {
                alert('Wype≈Çnij wszystkie pola podstawowe (data, strefa, audytor)!');
                return;
            }

            if (Object.keys(answers).length < questions.length) {
                alert('Odpowiedz na wszystkie pytania!');
                return;
            }

            for (let key in answers) {
                if (answers[key] === 'no') {
                    const commentValue = document.getElementById(`comment_${key}`).value.trim();
                    if (!commentValue) {
                        alert('Wszystkie odpowiedzi "Nie" wymagajƒÖ komentarza opisujƒÖcego problem!');
                        return;
                    }
                    comments[key] = commentValue;
                }
            }

            let total = 0, correct = 0;
            let categoryScores = [0, 0, 0, 0, 0];
            let categoryTotals = [0, 0, 0, 0, 0];
            
            for (let key in answers) {
                total++;
                const cat = parseInt(key.split('_')[0]) - 1;
                categoryTotals[cat]++;
                
                if (answers[key] === 'yes' || answers[key] === 'na') {
                    correct++;
                    categoryScores[cat]++;
                }
            }

            const score = Math.round((correct / total) * 100);
            const categoryPercentages = categoryScores.map((s, i) => 
                categoryTotals[i] > 0 ? Math.round((s / categoryTotals[i]) * 100) : 0
            );

            const zoneSelect = document.getElementById('zone');
            const selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
            const target = parseInt(selectedOption.dataset.target);
            const responsible = selectedOption.dataset.responsible;

            const observations = [];
            let questionNumber = 1;
            for (let cat = 1; cat <= 5; cat++) {
                const catQuestions = questions.filter(q => q.category === cat);
                catQuestions.forEach((q, idx) => {
                    const key = `${cat}_${idx}`;
                    if (comments[key]) {
                        observations.push({
                            id: Date.now() + Math.random(),
                            source: '5S',
                            category: `${cat}S - ${categoryNames[cat - 1]}`,
                            questionNumber: questionNumber,
                            description: q.question,
                            comment: comments[key],
                            actions: comments[key],
                            status: 'Otwarte',
                            responsible: responsible,
                            priority: 'medium',
                            createdDate: date,
                            dueDate: new Date(new Date(date).getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                        });
                    }
                    questionNumber++;
                });
            }

            const auditData = {
                type: '5S',
                branch: branch.code,
                branchName: branch.name,
                date: date,
                timestamp: new Date().toISOString(),
                zone: zone,
                zoneResponsible: responsible,
                auditor: auditor,
                answers: answers,
                comments: comments,
                score: score,
                target: target,
                categoryScores: categoryPercentages,
                status: score >= target ? 'Pozytywny' : 'Wymaga uwagi',
                observations: observations,
                observationsCount: observations.length
            };

            try {
                let localAudits = JSON.parse(localStorage.getItem('5s_mobile_audits') || '[]');
                localAudits.push(auditData);
                localStorage.setItem('5s_mobile_audits', JSON.stringify(localAudits));
            } catch (e) {
                console.warn('Nie mo≈ºna zapisaƒá do localStorage:', e);
            }

            const fileName = CEVA_CONFIG.generateFileName('5s', zone, date);

            const json = JSON.stringify(auditData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);

            showResult(score, target, fileName);
        }

        function showResult(score, target, fileName) {
            document.getElementById('formSection').style.display = 'none';
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.add('visible');
            
            document.getElementById('scoreDisplay').textContent = score + '%';
            
            const statusEl = document.getElementById('scoreStatus');
            if (score >= target) {
                statusEl.textContent = '‚úì Pozytywny';
                statusEl.className = 'score-status pass';
            } else {
                statusEl.textContent = '‚ö† Wymaga uwagi';
                statusEl.className = 'score-status fail';
            }
            
            document.getElementById('fileName').textContent = fileName;
            
            const sharePointUrl = CEVA_CONFIG.getSharePointFolderUrl(branch.code, 'fiveS');
            document.getElementById('openSharePoint').onclick = function() {
                window.open(sharePointUrl, '_blank');
            };
        }
    </script>
</body>
</html>
