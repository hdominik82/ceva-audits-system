<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macierz Kompetencji</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .back-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .header h1 { color: white; font-size: 1.4em; font-weight: 300; }
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            padding: 0 15px;
            overflow-x: auto;
        }
        .nav-tab {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-tab.active { color: white; border-bottom-color: #f9ca24; }
        .nav-tab:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .content { padding: 15px; height: calc(100vh - 120px); overflow-y: auto; }
        .content-section { display: none; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .content-section.active { display: block; }
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; color: #333; border-bottom: 3px solid #f9ca24; padding-bottom: 10px; }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn {
            background: #f9ca24;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn:hover { background: #f0932b; transform: translateY(-2px); }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-warning { background: #e67e22; color: white; }
        .btn-warning:hover { background: #d35400; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .matrix-container {
            height: calc(100vh - 380px);
            overflow: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75em;
        }
        .matrix-table th.process-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 20px;  /* zmieniono z 60px */
            max-width: 20px;  /* zmieniono z 60px */
            padding: 8px 5px; /* zmniejszono padding */
            height: 90px;
            vertical-align: bottom;
            white-space: nowrap;
        }
        .matrix-table th.employee-header {
            left: 0;
            z-index: 30;
            min-width: 50px;  /* zwiÄ™kszono z 150px */
            text-align: left;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .matrix-table th.department-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.9em;
        }
        .matrix-table td {
			padding: 2px;  /* zmniejszono z 4px */
			border: 1px solid #e0e0e0;
			text-align: center;
			vertical-align: middle;
		}
		.matrix-container {
			height: calc(100vh - 380px);
			overflow: auto;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			background: white;
			overflow-x: auto;  /* dodano poziomy scroll */
		}
        .matrix-table td.employee-name {
            position: sticky;
            left: 0;
            background: white;
            font-weight: 600;
            text-align: left;
            z-index: 10;
            font-size: 0.85em;
        }
        .matrix-table tbody tr:hover td {
            background: #f8f9fa;
        }
        .skill-level {
            width: 30%;
            padding: 6px 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            text-align: center;
        }
        .level-0 { background: #ecf0f1; color: #7f8c8d; }
        .level-1 { background: #fff3e0; color: #e65100; }
        .level-2 { background: #e8f5e9; color: #2e7d32; }
        .level-3 { background: #1565c0; color: white; }
        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }
        .legend-box {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f9ca24;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover { color: #333; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .gap-warning {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .target-info {
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-top: 3px;
        }
        .skill-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'">â† PowrÃ³t</button>
        <h1>Macierz Kompetencji</h1>
        <div></div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" data-section="processMatrix">Macierz ProcesÃ³w</button>
        <button class="nav-tab" data-section="skillsMatrix">Dodatkowe Kompetencje</button>
        <button class="nav-tab" data-section="reports">Raporty</button>
        <button class="nav-tab" data-section="config">Konfiguracja</button>
    </div>

    <div class="content">
        <!-- Macierz ProcesÃ³w -->
        <div id="processMatrix" class="content-section active">
            <div class="section-title">Macierz Kompetencji Procesowych</div>
            
            <div class="action-buttons">
                <button class="btn" id="btnRefreshMatrix">OdÅ›wieÅ¼ dane</button>
                <button class="btn btn-success" id="btnSaveMatrix">Zapisz zmiany</button>
                <button class="btn btn-warning" id="btnExportMatrix">Eksport do Excel</button>
                <button class="btn btn-secondary" id="btnExportJSON">Eksport JSON</button>
                <button class="btn btn-secondary" id="btnImportJSON">Import JSON</button>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-box level-0"></div>
                    <span>0 - Brak kompetencji</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box level-1"></div>
                    <span>1 - W trakcie szkolenia</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box level-2"></div>
                    <span>2 - Samodzielny</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box level-3"></div>
                    <span>3 - Trener</span>
                </div>
            </div>

            <div class="matrix-container">
                <table class="matrix-table" id="processMatrixTable"></table>
            </div>
        </div>

        <!-- Macierz Dodatkowych Kompetencji -->
        <div id="skillsMatrix" class="content-section">
            <div class="section-title">Dodatkowe Kompetencje</div>
            
            <div class="action-buttons">
                <button class="btn" id="btnAddSkill">Dodaj kompetencjÄ™</button>
                <button class="btn btn-success" id="btnSaveSkills">Zapisz zmiany</button>
                <button class="btn btn-warning" id="btnExportSkills">Eksport do Excel</button>
            </div>

            <div class="matrix-container">
                <table class="matrix-table" id="skillsMatrixTable"></table>
            </div>
        </div>

        <!-- Raporty -->
        <div id="reports" class="content-section">
            <div class="section-title">Raporty i Analiza Luk</div>
            
            <div class="action-buttons">
                <button class="btn" id="btnGapReport">Raport luk kompetencyjnych</button>
                <button class="btn" id="btnDeptReport">Raport per dziaÅ‚</button>
                <button class="btn" id="btnTrainerReport">Raport trenerÃ³w</button>
            </div>

            <div id="reportContent" style="background: #f8f9fa; padding: 20px; border-radius: 10px; min-height: 400px;">
                <p style="text-align: center; color: #666; margin-top: 100px;">
                    Wybierz typ raportu powyÅ¼ej
                </p>
            </div>
        </div>

        <!-- Konfiguracja -->
        <div id="config" class="content-section">
            <div class="section-title">Konfiguracja</div>
            
            <!-- DziaÅ‚y i Procesy -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Struktura: DziaÅ‚y â†’ Procesy</h3>
                <div style="display: flex; gap: 10px; margin: 15px 0;">
                    <input type="text" id="newDeptName" class="form-control" placeholder="Nazwa dziaÅ‚u" style="flex: 1;">
                    <button class="btn" id="btnAddDept">Dodaj dziaÅ‚</button>
                </div>
                <div id="deptProcessList"></div>
            </div>

            <!-- Cele procesÃ³w -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Cele iloÅ›ciowe przeszkolonych osÃ³b per proces</h3>
                <div id="processTargetsList"></div>
            </div>

            <!-- Dodatkowe kompetencje -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3>ZarzÄ…dzanie dodatkowymi kompetencjami</h3>
                <div id="additionalSkillsList"></div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania procesu -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Dodaj proces do dziaÅ‚u</h3>
                <span class="close" id="closeProcessModal">&times;</span>
            </div>
            <form id="processForm">
                <div class="form-group">
                    <label>Nazwa procesu:*</label>
                    <input type="text" id="processName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Cel (iloÅ›Ä‡ przeszkolonych osÃ³b):*</label>
                    <input type="number" id="processTarget" class="form-control" min="1" required>
                </div>
                <input type="hidden" id="processDeptId">
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelProcessModal">Anuluj</button>
                    <button type="submit" class="btn">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal dodatkowej kompetencji -->
    <div id="skillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Dodaj dodatkowÄ… kompetencjÄ™</h3>
                <span class="close" id="closeSkillModal">&times;</span>
            </div>
            <form id="skillForm">
                <div class="form-group">
                    <label>Nazwa kompetencji:*</label>
                    <input type="text" id="skillName" class="form-control" placeholder="np. Pierwsza Pomoc, Ewakuacja, 5S" required>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelSkillModal">Anuluj</button>
                    <button type="submit" class="btn">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <input type="file" id="jsonFileInput" style="display: none;" accept=".json">

    <script>
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        let departments = JSON.parse(localStorage.getItem('dept_structure') || '[]');
        let processMatrix = JSON.parse(localStorage.getItem('process_matrix') || '{}');
        let additionalSkills = JSON.parse(localStorage.getItem('additional_skills') || '["Pierwsza Pomoc", "Ewakuacja", "5S", "BHP"]');
        let skillsMatrix = JSON.parse(localStorage.getItem('skills_matrix') || '{}');

        // Inicjalizacja domyÅ›lnej struktury
        if (departments.length === 0) {
            departments = [
                {
                    id: 1,
                    name: 'B2B',
                    processes: [
                        { id: 101, name: 'MontaÅ¼ B2B', target: 3 },
                        { id: 102, name: 'Pakowanie B2B', target: 2 }
                    ]
                },
                {
                    id: 2,
                    name: 'B2C',
                    processes: [
                        { id: 201, name: 'Kompletacja B2C', target: 4 },
                        { id: 202, name: 'WysyÅ‚ka B2C', target: 2 }
                    ]
                }
            ];
            localStorage.setItem('dept_structure', JSON.stringify(departments));
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupNavigation();
            setupButtons();
            setupModals();
            loadProcessMatrix();
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        function showSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            const section = document.getElementById(name);
            if (section) section.classList.add('active');
            
            document.querySelector(`.nav-tab[data-section="${name}"]`).classList.add('active');
            
            if (name === 'processMatrix') loadProcessMatrix();
            else if (name === 'skillsMatrix') loadSkillsMatrix();
            else if (name === 'config') loadConfig();
        }

        function setupButtons() {
            document.getElementById('btnRefreshMatrix').addEventListener('click', loadProcessMatrix);
            document.getElementById('btnSaveMatrix').addEventListener('click', saveProcessMatrix);
            document.getElementById('btnExportMatrix').addEventListener('click', exportProcessMatrix);
            document.getElementById('btnExportJSON').addEventListener('click', exportAllDataToJSON);
            document.getElementById('btnImportJSON').addEventListener('click', importDataFromJSON);
            
            document.getElementById('btnAddSkill').addEventListener('click', openSkillModal);
            document.getElementById('btnSaveSkills').addEventListener('click', saveSkillsMatrix);
            document.getElementById('btnExportSkills').addEventListener('click', exportSkillsMatrix);
            
            document.getElementById('btnGapReport').addEventListener('click', generateGapReport);
            document.getElementById('btnDeptReport').addEventListener('click', generateDeptReport);
            document.getElementById('btnTrainerReport').addEventListener('click', generateTrainerReport);
            
            document.getElementById('btnAddDept').addEventListener('click', addDepartment);
        }

        function setupModals() {
			// Process modal
			const processModal = document.getElementById('processModal');
			const closeProcessBtn = document.getElementById('closeProcessModal');
			const cancelProcessBtn = document.getElementById('cancelProcessModal');
    
			if (closeProcessBtn) {
				closeProcessBtn.onclick = function() {
					processModal.style.display = 'none';
				};
			}
			
			if (cancelProcessBtn) {
				cancelProcessBtn.onclick = function() {
					processModal.style.display = 'none';
				};
			}
			
			// Skill modal
			const skillModal = document.getElementById('skillModal');
			const closeSkillBtn = document.getElementById('closeSkillModal');
			const cancelSkillBtn = document.getElementById('cancelSkillModal');
			
			if (closeSkillBtn) {
				closeSkillBtn.onclick = function() {
					skillModal.style.display = 'none';
				};
			}
			
			if (cancelSkillBtn) {
				cancelSkillBtn.onclick = function() {
					skillModal.style.display = 'none';
				};
			}
			
			// Process form submit
			document.getElementById('processForm').addEventListener('submit', function(e) {
				e.preventDefault();
				saveProcess();
			});
			
			// Skill form submit
			document.getElementById('skillForm').addEventListener('submit', function(e) {
				e.preventDefault();
				saveAdditionalSkill();
			});
			
			// Close on outside click
			window.addEventListener('click', function(e) {
				if (e.target === processModal) {
					processModal.style.display = 'none';
				}
				if (e.target === skillModal) {
					skillModal.style.display = 'none';
				}
			});
		}

        // MACIERZ PROCESÃ“W
        function loadProcessMatrix() {
            const table = document.getElementById('processMatrixTable');
            const activeEmployees = employees.filter(e => e.status === 'active' || e.status === 'training');
            
            if (activeEmployees.length === 0 || departments.length === 0) {
                table.innerHTML = '<tr><td style="padding: 40px; text-align: center;">Brak danych. Dodaj pracownikÃ³w i skonfiguruj strukturÄ™ dziaÅ‚Ã³w.</td></tr>';
                return;
            }
            
            let html = '<thead><tr><th class="employee-header">Pracownik</th>';
            
            // NagÅ‚Ã³wki dziaÅ‚Ã³w i procesÃ³w
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    html += `<th colspan="${dept.processes.length}" class="department-header">${dept.name}</th>`;
                }
            });
            html += '</tr><tr><th class="employee-header"></th>';
            
            // NagÅ‚Ã³wki procesÃ³w - pionowo
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    dept.processes.forEach(proc => {
                        const trained = countTrainedEmployees(proc.id);
                        const gapInfo = trained < proc.target ? `${trained}/${proc.target}` : `${trained}/${proc.target} âœ“`;
                        html += `<th class="process-header">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="margin-bottom: 5px;">${proc.name}</div>
                                <div style="font-size: 0.75em; background: ${trained < proc.target ? '#ffebee' : '#e8f5e9'}; padding: 2px 4px; border-radius: 3px;">${gapInfo}</div>
                            </div>
                        </th>`;
                    });
                }
            });
            html += '</tr></thead><tbody>';
            
            // Wiersze pracownikÃ³w
            activeEmployees.forEach(emp => {
                html += `<tr><td class="employee-name">${emp.firstName} ${emp.lastName}<br><small style="color: #666;">${emp.department}</small></td>`;
                
                departments.forEach(dept => {
                    if (dept.processes && dept.processes.length > 0) {
                        dept.processes.forEach(proc => {
                            const key = `${emp.id}_${proc.id}`;
                            const level = processMatrix[key] || 0;
                            
                            html += `<td>
                                <select class="skill-level level-${level}" 
                                        onchange="updateProcessLevel(${emp.id}, ${proc.id}, this.value)"
                                        data-emp="${emp.id}" data-proc="${proc.id}">
                                    <option value="0" ${level === 0 ? 'selected' : ''}>0</option>
                                    <option value="1" ${level === 1 ? 'selected' : ''}>1</option>
                                    <option value="2" ${level === 2 ? 'selected' : ''}>2</option>
                                    <option value="3" ${level === 3 ? 'selected' : ''}>3</option>
                                </select>
                            </td>`;
                        });
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function updateProcessLevel(empId, procId, level) {
            const key = `${empId}_${procId}`;
            processMatrix[key] = parseInt(level);
            
            const select = document.querySelector(`select[data-emp="${empId}"][data-proc="${procId}"]`);
            if (select) {
                select.className = `skill-level level-${level}`;
            }
        }

        function saveProcessMatrix() {
            localStorage.setItem('process_matrix', JSON.stringify(processMatrix));
            alert('Macierz procesÃ³w zostaÅ‚a zapisana!');
        }

        function countTrainedEmployees(procId) {
            let count = 0;
            employees.filter(e => e.status === 'active' || e.status === 'training').forEach(emp => {
                const key = `${emp.id}_${procId}`;
                const level = processMatrix[key] || 0;
                if (level >= 2) count++; // Samodzielny lub Trener
            });
            return count;
        }

        // MACIERZ DODATKOWYCH KOMPETENCJI
        function loadSkillsMatrix() {
            const table = document.getElementById('skillsMatrixTable');
            const activeEmployees = employees.filter(e => e.status === 'active' || e.status === 'training');
            
            if (activeEmployees.length === 0 || additionalSkills.length === 0) {
                table.innerHTML = '<tr><td style="padding: 40px; text-align: center;">Brak danych. Dodaj pracownikÃ³w i kompetencje.</td></tr>';
                return;
            }
            
            let html = '<thead><tr><th class="employee-header">Pracownik</th>';
            
            additionalSkills.forEach(skill => {
                html += `<th style="min-width: 120px;">${skill}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            activeEmployees.forEach(emp => {
                html += `<tr><td class="employee-name">${emp.firstName} ${emp.lastName}<br><small style="color: #666;">${emp.department}</small></td>`;
                
                additionalSkills.forEach(skill => {
                    const key = `${emp.id}_${skill}`;
                    const hasSkill = skillsMatrix[key] || false;
                    
                    html += `<td>
                        <input type="checkbox" class="skill-checkbox" 
                               ${hasSkill ? 'checked' : ''}
                               onchange="toggleSkill(${emp.id}, '${skill}', this.checked)">
                    </td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function toggleSkill(empId, skill, checked) {
            const key = `${empId}_${skill}`;
            skillsMatrix[key] = checked;
        }

        function saveSkillsMatrix() {
            localStorage.setItem('skills_matrix', JSON.stringify(skillsMatrix));
            alert('Macierz dodatkowych kompetencji zostaÅ‚a zapisana!');
        }

        function openSkillModal() {
            document.getElementById('skillForm').reset();
            document.getElementById('skillModal').style.display = 'block';
        }

        function saveAdditionalSkill() {
            const name = document.getElementById('skillName').value.trim();
            if (name && !additionalSkills.includes(name)) {
                additionalSkills.push(name);
                localStorage.setItem('additional_skills', JSON.stringify(additionalSkills));
                document.getElementById('skillModal').style.display = 'none';
                loadSkillsMatrix();
                loadConfig();
                alert('Kompetencja dodana!');
            } else {
                alert('Kompetencja juÅ¼ istnieje lub pole jest puste');
            }
        }

        // KONFIGURACJA
        function loadConfig() {
            loadDeptProcessStructure();
            loadProcessTargets();
            loadAdditionalSkillsConfig();
        }

        function loadDeptProcessStructure() {
            const container = document.getElementById('deptProcessList');
            container.innerHTML = '';
            
            departments.forEach(dept => {
                const div = document.createElement('div');
                div.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #667eea;';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>${dept.name}</h4>
                        <div>
                            <button class="btn" onclick="openProcessModal(${dept.id})" style="padding: 6px 12px; font-size: 0.85em; margin-right: 5px;">+ Dodaj proces</button>
                            <button class="btn btn-secondary" onclick="deleteDept(${dept.id})" style="padding: 6px 12px; font-size: 0.85em;">UsuÅ„ dziaÅ‚</button>
                        </div>
                    </div>
                    <div style="padding-left: 20px;">
                        ${dept.processes && dept.processes.length > 0 ? 
                            dept.processes.map(proc => `
                                <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin: 5px 0; display: flex; justify-content: space-between;">
                                    <span>â†’ ${proc.name} (Cel: ${proc.target} osÃ³b)</span>
                                    <button class="btn btn-secondary" onclick="deleteProcess(${dept.id}, ${proc.id})" style="padding: 4px 8px; font-size: 0.75em;">UsuÅ„</button>
                                </div>
                            `).join('') : 
                            '<p style="color: #666; font-size: 0.9em;">Brak procesÃ³w</p>'
                        }
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function loadProcessTargets() {
            const container = document.getElementById('processTargetsList');
            container.innerHTML = '';
            
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    dept.processes.forEach(proc => {
                        const trained = countTrainedEmployees(proc.id);
                        const gap = proc.target - trained;
                        
                        const div = document.createElement('div');
                        div.style.cssText = `padding: 10px; background: ${gap > 0 ? '#ffebee' : '#e8f5e9'}; border-radius: 6px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center;`;
                        div.innerHTML = `
                            <div>
                                <strong>${dept.name} â†’ ${proc.name}</strong><br>
                                <small>Cel: ${proc.target} osÃ³b | Przeszkolonych: ${trained} | ${gap > 0 ? `Brakuje: ${gap}` : 'Cel osiÄ…gniÄ™ty âœ“'}</small>
                            </div>
                            <input type="number" value="${proc.target}" min="1" 
                                   onchange="updateProcessTarget(${dept.id}, ${proc.id}, this.value)"
                                   style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        `;
                        container.appendChild(div);
                    });
                }
            });
        }

        function loadAdditionalSkillsConfig() {
            const container = document.getElementById('additionalSkillsList');
            container.innerHTML = additionalSkills.map(skill => 
                `<div style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center;">
                    <span>${skill}</span>
                    <button class="btn btn-secondary" onclick="deleteSkill('${skill}')" style="padding: 4px 8px; font-size: 0.8em;">UsuÅ„</button>
                </div>`
            ).join('');
        }

        function addDepartment() {
            const name = document.getElementById('newDeptName').value.trim();
            if (name) {
                departments.push({
                    id: Date.now(),
                    name: name,
                    processes: []
                });
                localStorage.setItem('dept_structure', JSON.stringify(departments));
                loadConfig();
                document.getElementById('newDeptName').value = '';
            }
        }

        function deleteDept(deptId) {
            if (confirm('Czy na pewno chcesz usunÄ…Ä‡ ten dziaÅ‚ wraz ze wszystkimi procesami?')) {
                departments = departments.filter(d => d.id !== deptId);
                localStorage.setItem('dept_structure', JSON.stringify(departments));
                loadConfig();
                loadProcessMatrix();
            }
        }

        function openProcessModal(deptId) {
            document.getElementById('processForm').reset();
            document.getElementById('processDeptId').value = deptId;
            document.getElementById('processTarget').value = 3;
            document.getElementById('processModal').style.display = 'block';
        }

        function saveProcess() {
            const deptId = parseInt(document.getElementById('processDeptId').value);
            const name = document.getElementById('processName').value.trim();
            const target = parseInt(document.getElementById('processTarget').value);
            
            const dept = departments.find(d => d.id === deptId);
            if (dept && name && target > 0) {
                if (!dept.processes) dept.processes = [];
                dept.processes.push({
                    id: Date.now(),
                    name: name,
                    target: target
                });
                localStorage.setItem('dept_structure', JSON.stringify(departments));
                document.getElementById('processModal').style.display = 'none';
                loadConfig();
                loadProcessMatrix();
                alert('Proces dodany!');
            }
        }

        function deleteProcess(deptId, procId) {
            if (confirm('Czy na pewno chcesz usunÄ…Ä‡ ten proces?')) {
                const dept = departments.find(d => d.id === deptId);
                if (dept && dept.processes) {
                    dept.processes = dept.processes.filter(p => p.id !== procId);
                    localStorage.setItem('dept_structure', JSON.stringify(departments));
                    loadConfig();
                    loadProcessMatrix();
                }
            }
        }

        function updateProcessTarget(deptId, procId, newTarget) {
            const dept = departments.find(d => d.id === deptId);
            if (dept && dept.processes) {
                const proc = dept.processes.find(p => p.id === procId);
                if (proc) {
                    proc.target = parseInt(newTarget);
                    localStorage.setItem('dept_structure', JSON.stringify(departments));
                    loadConfig();
                    loadProcessMatrix();
                }
            }
        }

        function deleteSkill(skillName) {
            if (confirm(`Czy na pewno chcesz usunÄ…Ä‡ kompetencjÄ™ "${skillName}"?`)) {
                additionalSkills = additionalSkills.filter(s => s !== skillName);
                localStorage.setItem('additional_skills', JSON.stringify(additionalSkills));
                loadConfig();
                loadSkillsMatrix();
            }
        }

        // RAPORTY
        function generateGapReport() {
            const content = document.getElementById('reportContent');
            let html = '<h2>Raport Luk Kompetencyjnych</h2>';
            html += '<p style="color: #666; margin-bottom: 20px;">Procesy, ktÃ³re nie osiÄ…gnÄ™Å‚y celu iloÅ›ci przeszkolonych osÃ³b</p>';
            
            const gaps = [];
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    dept.processes.forEach(proc => {
                        const trained = countTrainedEmployees(proc.id);
                        const gap = proc.target - trained;
                        if (gap > 0) {
                            gaps.push({
                                dept: dept.name,
                                process: proc.name,
                                target: proc.target,
                                trained: trained,
                                gap: gap
                            });
                        }
                    });
                }
            });
            
            if (gaps.length === 0) {
                html += '<p style="text-align: center; color: #27ae60; font-size: 1.2em; margin-top: 40px;">Wszystkie procesy osiÄ…gnÄ™Å‚y cele!</p>';
            } else {
                gaps.sort((a, b) => b.gap - a.gap);
                
                html += '<div style="background: #ffebee; padding: 15px; border-radius: 8px; margin: 15px 0;">';
                html += '<h3 style="color: #c62828; margin-bottom: 15px;">Wykryte luki</h3>';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f5f5f5;"><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">DziaÅ‚</th><th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Proces</th><th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Cel</th><th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Przeszkolonych</th><th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Brakuje</th></tr></thead><tbody>';
                
                gaps.forEach(g => {
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${g.dept}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;"><strong>${g.process}</strong></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${g.target}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${g.trained}</td>
                        <td style="padding: 10px; text-align: center; border: 1px solid #ddd; background: #ffcdd2; font-weight: bold;">${g.gap}</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
            }
            
            content.innerHTML = html;
        }

        function generateDeptReport() {
            const content = document.getElementById('reportContent');
            let html = '<h2>Raport per DziaÅ‚</h2>';
            
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    const totalTarget = dept.processes.reduce((sum, p) => sum + p.target, 0);
                    const totalTrained = dept.processes.reduce((sum, p) => sum + countTrainedEmployees(p.id), 0);
                    const coverage = totalTarget > 0 ? Math.round((totalTrained / totalTarget) * 100) : 0;
                    
                    html += `<div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #667eea;">`;
                    html += `<h3>${dept.name}</h3>`;
                    html += `<p><strong>Pokrycie ogÃ³lne:</strong> ${coverage}% (${totalTrained}/${totalTarget})</p>`;
                    html += `<div style="margin-top: 15px;">`;
                    
                    dept.processes.forEach(proc => {
                        const trained = countTrainedEmployees(proc.id);
                        const procCoverage = proc.target > 0 ? Math.round((trained / proc.target) * 100) : 0;
                        const color = procCoverage >= 100 ? '#27ae60' : procCoverage >= 50 ? '#f39c12' : '#e74c3c';
                        
                        html += `<div style="padding: 10px; background: #f8f9fa; border-radius: 6px; margin: 5px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${proc.name}</strong></span>
                                <span style="color: ${color}; font-weight: bold;">${trained}/${proc.target} (${procCoverage}%)</span>
                            </div>
                            <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${Math.min(procCoverage, 100)}%;"></div>
                            </div>
                        </div>`;
                    });
                    
                    html += `</div></div>`;
                }
            });
            
            content.innerHTML = html;
        }

        function generateTrainerReport() {
            const content = document.getElementById('reportContent');
            let html = '<h2>Raport TrenerÃ³w</h2>';
            html += '<p style="color: #666; margin-bottom: 20px;">Pracownicy z poziomem 3 (Trener) dla poszczegÃ³lnych procesÃ³w</p>';
            
            const trainers = {};
            departments.forEach(dept => {
                if (dept.processes && dept.processes.length > 0) {
                    dept.processes.forEach(proc => {
                        const procTrainers = [];
                        employees.filter(e => e.status === 'active' || e.status === 'training').forEach(emp => {
                            const key = `${emp.id}_${proc.id}`;
                            if (processMatrix[key] === 3) {
                                procTrainers.push(`${emp.firstName} ${emp.lastName}`);
                            }
                        });
                        if (procTrainers.length > 0) {
                            if (!trainers[dept.name]) trainers[dept.name] = {};
                            trainers[dept.name][proc.name] = procTrainers;
                        }
                    });
                }
            });
            
            if (Object.keys(trainers).length === 0) {
                html += '<p style="text-align: center; color: #666; margin-top: 40px;">Brak przypisanych trenerÃ³w</p>';
            } else {
                Object.entries(trainers).forEach(([dept, processes]) => {
                    html += `<div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #1565c0;">`;
                    html += `<h3>${dept}</h3>`;
                    
                    Object.entries(processes).forEach(([proc, trainerList]) => {
                        html += `<div style="padding: 10px; background: #e3f2fd; border-radius: 6px; margin: 10px 0;">
                            <strong>${proc}:</strong><br>
                            ${trainerList.map(t => `<span style="display: inline-block; background: #1565c0; color: white; padding: 4px 8px; border-radius: 4px; margin: 3px;">${t}</span>`).join('')}
                        </div>`;
                    });
                    
                    html += `</div>`;
                });
            }
            
            content.innerHTML = html;
        }

        // EXPORT
        function exportProcessMatrix() {
            const data = [];
            const activeEmployees = employees.filter(e => e.status === 'active' || e.status === 'training');
            
            activeEmployees.forEach(emp => {
                const row = {
                    'Pracownik': `${emp.firstName} ${emp.lastName}`,
                    'DziaÅ‚ pracownika': emp.department
                };
                
                departments.forEach(dept => {
                    if (dept.processes && dept.processes.length > 0) {
                        dept.processes.forEach(proc => {
                            const key = `${emp.id}_${proc.id}`;
                            const level = processMatrix[key] || 0;
                            row[`${dept.name} - ${proc.name}`] = level;
                        });
                    }
                });
                
                data.push(row);
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Macierz ProcesÃ³w');
            XLSX.writeFile(wb, `Macierz_Procesow_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportSkillsMatrix() {
            const data = [];
            const activeEmployees = employees.filter(e => e.status === 'active' || e.status === 'training');
            
            activeEmployees.forEach(emp => {
                const row = {
                    'Pracownik': `${emp.firstName} ${emp.lastName}`,
                    'DziaÅ‚': emp.department
                };
                
                additionalSkills.forEach(skill => {
                    const key = `${emp.id}_${skill}`;
                    row[skill] = skillsMatrix[key] ? 'TAK' : 'NIE';
                });
                
                data.push(row);
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dodatkowe Kompetencje');
            XLSX.writeFile(wb, `Dodatkowe_Kompetencje_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // EXPORT/IMPORT JSON
        function exportAllDataToJSON() {
            const allData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                competencyMatrix: {
                    employees: employees,
                    departments: departments,
                    processMatrix: processMatrix,
                    additionalSkills: additionalSkills,
                    skillsMatrix: skillsMatrix
                },
                training: {
                    instructions: JSON.parse(localStorage.getItem('instructions') || '[]'),
                    trainings: JSON.parse(localStorage.getItem('trainings') || '[]'),
                    onboardingSteps: JSON.parse(localStorage.getItem('onboarding_steps') || '[]')
                },
                audits: {
                    fiveS: {
                        zones: JSON.parse(localStorage.getItem('5s_zones') || '[]'),
                        auditors: JSON.parse(localStorage.getItem('5s_auditors') || '[]'),
                        questions: JSON.parse(localStorage.getItem('5s_questions') || '[]'),
                        history: JSON.parse(localStorage.getItem('5s_history') || '[]')
                    },
                    actionPlan: JSON.parse(localStorage.getItem('action_plan') || '[]')
                }
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `System_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Wszystkie dane zostaÅ‚y wyeksportowane do pliku JSON');
        }

        function importDataFromJSON() {
            const input = document.getElementById('jsonFileInput');
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            if (confirm('Czy na pewno chcesz zaimportowaÄ‡ dane? Obecne dane zostanÄ… nadpisane!')) {
                                // Macierz kompetencji
                                if (importedData.competencyMatrix) {
                                    if (importedData.competencyMatrix.employees) {
                                        localStorage.setItem('employees', JSON.stringify(importedData.competencyMatrix.employees));
                                        employees = importedData.competencyMatrix.employees;
                                    }
                                    if (importedData.competencyMatrix.departments) {
                                        localStorage.setItem('dept_structure', JSON.stringify(importedData.competencyMatrix.departments));
                                        departments = importedData.competencyMatrix.departments;
                                    }
                                    if (importedData.competencyMatrix.processMatrix) {
                                        localStorage.setItem('process_matrix', JSON.stringify(importedData.competencyMatrix.processMatrix));
                                        processMatrix = importedData.competencyMatrix.processMatrix;
                                    }
                                    if (importedData.competencyMatrix.additionalSkills) {
                                        localStorage.setItem('additional_skills', JSON.stringify(importedData.competencyMatrix.additionalSkills));
                                        additionalSkills = importedData.competencyMatrix.additionalSkills;
                                    }
                                    if (importedData.competencyMatrix.skillsMatrix) {
                                        localStorage.setItem('skills_matrix', JSON.stringify(importedData.competencyMatrix.skillsMatrix));
                                        skillsMatrix = importedData.competencyMatrix.skillsMatrix;
                                    }
                                }
                                
                                // Szkolenia
                                if (importedData.training) {
                                    if (importedData.training.instructions) {
                                        localStorage.setItem('instructions', JSON.stringify(importedData.training.instructions));
                                    }
                                    if (importedData.training.trainings) {
                                        localStorage.setItem('trainings', JSON.stringify(importedData.training.trainings));
                                    }
                                    if (importedData.training.onboardingSteps) {
                                        localStorage.setItem('onboarding_steps', JSON.stringify(importedData.training.onboardingSteps));
                                    }
                                }
                                
                                // Audyty
                                if (importedData.audits) {
                                    if (importedData.audits.fiveS) {
                                        if (importedData.audits.fiveS.zones) {
                                            localStorage.setItem('5s_zones', JSON.stringify(importedData.audits.fiveS.zones));
                                        }
                                        if (importedData.audits.fiveS.auditors) {
                                            localStorage.setItem('5s_auditors', JSON.stringify(importedData.audits.fiveS.auditors));
                                        }
                                        if (importedData.audits.fiveS.questions) {
                                            localStorage.setItem('5s_questions', JSON.stringify(importedData.audits.fiveS.questions));
                                        }
                                        if (importedData.audits.fiveS.history) {
                                            localStorage.setItem('5s_history', JSON.stringify(importedData.audits.fiveS.history));
                                        }
                                    }
                                    if (importedData.audits.actionPlan) {
                                        localStorage.setItem('action_plan', JSON.stringify(importedData.audits.actionPlan));
                                    }
                                }
                                
                                alert('Import zakoÅ„czony pomyÅ›lnie! OdÅ›wieÅ¼ stronÄ™.');
                                location.reload();
                            }
                        } catch (error) {
                            alert('BÅ‚Ä…d podczas importu: ' + error.message);
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
    </script>
</body>
</html>