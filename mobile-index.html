<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEVA Audits - Mobile</title>
    <!-- NAJPIERW załaduj loader -->
    <script src="mobile-config-loader.js"></script>
    <!-- style pozostają bez zmian -->
</head>
<body>
    <!-- HTML pozostaje bez zmian -->
    
    <script>
        let selectedBranchCode = null;

        // GŁÓWNA INICJALIZACJA - załaduj config z SharePoint
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Załaduj config z SharePoint
                CEVA_CONFIG = await CONFIG_LOADER.load();
                
                // Teraz kontynuuj normalną inicjalizację
                initializeApp();
                
            } catch (error) {
                console.error('Błąd inicjalizacji:', error);
                alert('Nie można załadować konfiguracji. Sprawdź połączenie z internetem.');
            }
        });
        
        function initializeApp() {
            const currentBranch = CEVA_CONFIG.getCurrentBranch();
            const savedBranch = localStorage.getItem('ceva_selected_branch');
            
            if (!savedBranch) {
                showBranchSelector();
            } else {
                updateBranchInfo(currentBranch);
            }
        }
        
        // Dodaj przycisk do wymuszenia odświeżenia config
        function refreshConfig() {
            CONFIG_LOADER.load(true).then(config => {
                CEVA_CONFIG = config;
                alert('Konfiguracja odświeżona!');
                location.reload();
            });
        }

        // Pozostałe funkcje bez zmian...
        function updateBranchInfo(branch) {
            document.getElementById('branchName').textContent = branch.fullName || branch.name;
            document.getElementById('branchCode').textContent = branch.code;
        }

        function showBranchSelector() {
            const modal = document.getElementById('branchModal');
            const optionsContainer = document.getElementById('branchOptions');
            
            optionsContainer.innerHTML = '';
            
            Object.values(CEVA_CONFIG.branches).forEach(branch => {
                const option = document.createElement('div');
                option.className = 'branch-option';
                option.onclick = function() { selectBranch(branch.code, option); };
                option.innerHTML = `
                    <div class="branch-option-name">${branch.fullName || branch.name}</div>
                    <div class="branch-option-code">${branch.code}</div>
                `;
                optionsContainer.appendChild(option);
            });
            
            modal.classList.add('active');
        }

        function selectBranch(code, element) {
            document.querySelectorAll('.branch-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedBranchCode = code;
            
            document.getElementById('confirmBtn').disabled = false;
        }

        function confirmBranch() {
            if (!selectedBranchCode) return;
            
            CEVA_CONFIG.setBranch(selectedBranchCode);
            
            const branch = CEVA_CONFIG.getBranch(selectedBranchCode);
            updateBranchInfo(branch);
            
            document.getElementById('branchModal').classList.remove('active');
            
            selectedBranchCode = null;
            document.getElementById('confirmBtn').disabled = true;
        }
    </script>
</body>
</html>
